#![no_std]
#![no_main]

use defmt::{panic, *};
use defmt_rtt as _; // global logger
use embassy_executor::Spawner;
use embassy_futures::join::join;
use embassy_stm32::usb::{Driver, Instance};
use embassy_stm32::{Config, bind_interrupts, peripherals, usb};
use embassy_usb::Builder;
use embassy_usb::class::cdc_acm::{CdcAcmClass, State};
use embassy_usb::driver::EndpointError;
use panic_probe as _;

static VK: [u8; 2592] = [
    158, 41, 234, 146, 185, 41, 27, 225, 46, 178, 46, 248, 151, 40, 73, 59, 147, 27, 116, 81, 248,
    8, 158, 148, 78, 73, 68, 45, 224, 13, 255, 41, 168, 181, 21, 47, 236, 83, 166, 139, 244, 173,
    79, 253, 105, 13, 227, 45, 221, 232, 16, 181, 64, 98, 124, 84, 154, 252, 228, 227, 70, 10, 34,
    53, 200, 207, 159, 149, 180, 2, 40, 74, 249, 210, 233, 113, 77, 125, 162, 13, 15, 3, 154, 170,
    58, 81, 221, 65, 40, 97, 99, 60, 9, 8, 241, 42, 106, 11, 177, 1, 162, 87, 30, 134, 113, 155,
    54, 30, 179, 39, 164, 100, 188, 2, 250, 180, 6, 23, 195, 118, 155, 64, 5, 143, 244, 185, 17,
    76, 126, 232, 240, 234, 134, 125, 150, 235, 52, 153, 27, 40, 93, 200, 180, 53, 202, 142, 254,
    175, 10, 246, 131, 147, 58, 131, 161, 227, 90, 180, 9, 18, 204, 23, 132, 64, 245, 168, 209, 97,
    62, 104, 110, 100, 30, 121, 82, 121, 210, 160, 120, 48, 46, 225, 81, 78, 218, 68, 72, 77, 32,
    128, 112, 28, 179, 4, 178, 37, 184, 255, 76, 37, 20, 97, 72, 253, 145, 8, 211, 218, 166, 214,
    6, 50, 42, 4, 172, 176, 146, 119, 107, 255, 218, 9, 141, 125, 91, 112, 26, 240, 196, 9, 76, 96,
    91, 204, 49, 230, 165, 61, 83, 149, 149, 99, 153, 30, 193, 54, 94, 215, 207, 46, 32, 136, 138,
    28, 191, 139, 73, 23, 36, 100, 100, 119, 243, 245, 248, 198, 217, 255, 125, 223, 219, 49, 155,
    223, 247, 50, 33, 156, 26, 135, 187, 80, 238, 53, 196, 0, 96, 120, 21, 214, 63, 31, 246, 43, 2,
    74, 96, 180, 180, 239, 241, 225, 188, 234, 164, 141, 211, 237, 102, 184, 207, 188, 243, 204,
    198, 144, 232, 6, 45, 109, 228, 175, 235, 25, 141, 17, 31, 75, 192, 43, 215, 202, 114, 22, 90,
    82, 245, 241, 116, 82, 2, 90, 188, 104, 78, 183, 3, 87, 31, 86, 55, 182, 14, 50, 126, 19, 96,
    28, 217, 167, 80, 101, 164, 236, 75, 206, 193, 169, 244, 30, 144, 214, 169, 141, 168, 253, 236,
    99, 226, 140, 48, 127, 203, 177, 72, 74, 51, 9, 12, 49, 158, 27, 165, 90, 196, 73, 3, 134, 61,
    1, 117, 19, 124, 173, 111, 14, 103, 85, 66, 145, 212, 240, 20, 32, 173, 231, 4, 42, 123, 97,
    108, 87, 158, 50, 95, 98, 15, 176, 97, 53, 86, 79, 182, 150, 240, 255, 12, 30, 66, 29, 232,
    109, 13, 63, 120, 104, 173, 224, 69, 221, 41, 222, 37, 195, 21, 135, 185, 179, 243, 232, 171,
    108, 251, 2, 22, 113, 219, 87, 169, 173, 197, 25, 74, 100, 144, 223, 72, 9, 244, 40, 72, 187,
    66, 226, 58, 179, 177, 139, 128, 103, 46, 189, 68, 107, 155, 32, 90, 212, 98, 146, 46, 89, 116,
    223, 108, 149, 92, 64, 106, 118, 106, 253, 192, 105, 83, 145, 74, 255, 49, 150, 244, 207, 193,
    139, 46, 95, 171, 71, 104, 90, 251, 25, 141, 141, 151, 200, 154, 146, 80, 9, 122, 246, 195, 45,
    254, 159, 184, 217, 140, 95, 91, 95, 122, 128, 124, 57, 142, 28, 123, 215, 72, 225, 69, 173, 5,
    123, 36, 44, 220, 118, 234, 85, 46, 164, 123, 174, 173, 98, 108, 191, 50, 163, 76, 205, 7, 164,
    205, 167, 123, 102, 230, 101, 151, 5, 181, 7, 249, 87, 96, 69, 184, 55, 4, 53, 76, 5, 95, 121,
    133, 36, 52, 73, 100, 2, 205, 74, 34, 171, 96, 110, 104, 188, 237, 4, 87, 60, 209, 202, 243,
    221, 232, 23, 142, 218, 205, 149, 180, 79, 143, 59, 107, 18, 139, 177, 222, 198, 55, 218, 52,
    202, 218, 124, 235, 207, 129, 29, 133, 14, 245, 116, 25, 161, 253, 16, 75, 209, 199, 125, 74,
    142, 74, 223, 179, 81, 208, 179, 12, 218, 241, 47, 146, 111, 206, 202, 135, 136, 0, 179, 251,
    77, 14, 214, 139, 254, 205, 134, 204, 49, 56, 79, 156, 41, 248, 117, 136, 136, 181, 14, 92,
    151, 173, 251, 242, 202, 40, 74, 134, 109, 40, 38, 57, 59, 6, 166, 28, 69, 72, 18, 118, 152,
    81, 232, 132, 127, 240, 177, 58, 217, 124, 156, 36, 122, 175, 250, 143, 78, 28, 141, 162, 182,
    182, 173, 32, 64, 243, 242, 50, 175, 239, 216, 38, 200, 169, 251, 206, 36, 19, 180, 205, 81,
    220, 207, 163, 116, 60, 35, 192, 28, 152, 249, 132, 76, 132, 104, 112, 52, 30, 12, 50, 156,
    194, 255, 4, 247, 237, 232, 24, 147, 178, 188, 71, 133, 68, 233, 41, 207, 183, 168, 153, 156,
    129, 17, 223, 110, 8, 242, 43, 15, 119, 66, 232, 182, 115, 219, 118, 79, 46, 3, 246, 237, 24,
    68, 169, 52, 195, 124, 115, 122, 191, 138, 228, 173, 52, 101, 254, 4, 74, 198, 136, 228, 221,
    203, 70, 66, 250, 56, 121, 67, 110, 171, 34, 123, 215, 255, 254, 242, 68, 199, 229, 194, 2,
    215, 164, 216, 213, 160, 130, 205, 71, 147, 194, 125, 124, 253, 96, 198, 201, 249, 193, 56,
    165, 42, 28, 86, 66, 57, 227, 49, 57, 156, 252, 195, 248, 128, 11, 245, 23, 168, 119, 128, 6,
    70, 194, 89, 147, 189, 101, 177, 151, 178, 189, 89, 215, 58, 117, 134, 238, 172, 127, 6, 139,
    40, 71, 165, 252, 204, 161, 213, 182, 75, 159, 148, 85, 44, 197, 18, 71, 145, 182, 70, 9, 45,
    155, 142, 165, 36, 235, 97, 207, 139, 232, 156, 80, 33, 135, 5, 124, 44, 105, 102, 44, 181, 64,
    95, 33, 23, 153, 78, 210, 180, 125, 238, 245, 185, 221, 33, 84, 151, 196, 162, 106, 165, 191,
    117, 143, 20, 108, 160, 89, 162, 62, 163, 229, 80, 222, 220, 220, 179, 218, 150, 76, 144, 96,
    43, 147, 192, 186, 218, 18, 106, 100, 118, 242, 208, 52, 46, 14, 254, 60, 199, 245, 76, 78,
    182, 32, 117, 2, 94, 155, 61, 11, 2, 195, 166, 240, 200, 18, 172, 200, 176, 34, 238, 74, 31,
    65, 252, 6, 37, 109, 19, 78, 206, 189, 248, 13, 76, 176, 40, 13, 78, 136, 36, 108, 165, 27,
    187, 50, 114, 93, 121, 4, 35, 202, 233, 56, 164, 25, 180, 142, 117, 103, 175, 39, 202, 145,
    184, 242, 100, 186, 202, 84, 236, 174, 168, 145, 149, 34, 37, 217, 212, 216, 245, 30, 70, 252,
    209, 132, 19, 36, 130, 198, 255, 185, 137, 6, 5, 113, 78, 84, 4, 228, 244, 110, 0, 238, 20,
    213, 47, 48, 123, 255, 153, 7, 10, 97, 233, 162, 200, 65, 101, 129, 67, 127, 69, 202, 119, 199,
    227, 190, 243, 219, 173, 64, 100, 189, 131, 166, 208, 133, 15, 92, 210, 144, 26, 44, 146, 176,
    48, 195, 35, 85, 58, 118, 9, 143, 17, 143, 49, 40, 94, 82, 50, 228, 61, 25, 47, 26, 92, 197,
    76, 125, 148, 236, 8, 24, 253, 191, 104, 37, 21, 150, 54, 190, 238, 58, 239, 195, 177, 0, 208,
    173, 53, 105, 129, 55, 166, 51, 173, 180, 106, 238, 171, 139, 40, 192, 93, 232, 210, 24, 164,
    169, 154, 250, 247, 194, 11, 203, 235, 50, 105, 219, 99, 45, 12, 254, 53, 167, 6, 10, 218, 163,
    14, 118, 137, 92, 21, 20, 165, 161, 73, 230, 84, 214, 100, 212, 94, 204, 22, 96, 130, 241, 80,
    64, 61, 91, 10, 172, 223, 3, 13, 42, 29, 57, 39, 96, 23, 164, 185, 143, 184, 83, 136, 59, 89,
    146, 98, 30, 200, 153, 147, 100, 237, 5, 37, 74, 0, 171, 104, 80, 0, 105, 199, 246, 96, 203,
    48, 185, 250, 235, 165, 189, 197, 218, 2, 146, 121, 89, 252, 94, 26, 229, 55, 192, 200, 89, 89,
    23, 11, 176, 99, 16, 164, 71, 212, 98, 158, 253, 253, 34, 190, 66, 157, 117, 94, 195, 42, 18,
    224, 4, 159, 136, 189, 103, 52, 210, 76, 81, 88, 87, 114, 150, 130, 62, 245, 227, 86, 218, 93,
    152, 196, 204, 245, 166, 225, 95, 132, 40, 105, 52, 122, 44, 233, 61, 87, 87, 14, 7, 88, 108,
    108, 74, 54, 9, 203, 148, 156, 181, 3, 192, 102, 219, 75, 48, 219, 91, 249, 10, 201, 108, 85,
    25, 71, 135, 175, 41, 8, 188, 227, 170, 45, 92, 101, 54, 172, 187, 78, 231, 142, 38, 213, 121,
    88, 138, 171, 173, 224, 47, 247, 242, 87, 82, 184, 73, 228, 144, 190, 49, 49, 109, 254, 64, 52,
    103, 66, 154, 103, 159, 169, 234, 183, 41, 96, 101, 205, 20, 0, 56, 220, 154, 23, 109, 181, 52,
    63, 63, 16, 112, 237, 190, 129, 194, 114, 81, 127, 251, 89, 36, 228, 200, 130, 250, 40, 167,
    239, 98, 47, 214, 77, 62, 9, 119, 9, 65, 55, 119, 59, 29, 45, 245, 58, 82, 141, 245, 70, 77,
    184, 89, 206, 240, 59, 17, 16, 159, 205, 192, 217, 67, 230, 228, 139, 178, 83, 152, 9, 58, 140,
    147, 51, 18, 116, 175, 8, 102, 167, 148, 246, 223, 35, 163, 9, 69, 98, 98, 65, 57, 63, 160,
    173, 101, 123, 23, 97, 22, 20, 44, 197, 70, 109, 123, 196, 170, 98, 168, 237, 225, 83, 127, 81,
    134, 247, 220, 211, 25, 222, 60, 141, 234, 221, 125, 218, 132, 214, 43, 150, 189, 176, 101,
    243, 177, 207, 27, 44, 107, 243, 112, 66, 186, 79, 20, 76, 216, 153, 224, 97, 73, 116, 51, 34,
    110, 21, 157, 178, 155, 174, 100, 158, 235, 28, 29, 23, 121, 96, 68, 87, 123, 215, 31, 106,
    203, 94, 206, 61, 140, 115, 182, 249, 35, 211, 93, 65, 241, 225, 247, 32, 71, 83, 151, 133,
    136, 119, 29, 220, 88, 78, 216, 98, 106, 139, 113, 232, 106, 147, 99, 69, 56, 25, 248, 122, 13,
    154, 28, 24, 134, 40, 71, 87, 158, 212, 42, 183, 72, 70, 131, 168, 219, 48, 178, 182, 237, 151,
    43, 100, 124, 196, 85, 228, 87, 68, 65, 218, 29, 245, 184, 163, 133, 76, 8, 15, 43, 65, 182,
    90, 56, 55, 174, 166, 206, 24, 77, 135, 21, 65, 181, 159, 246, 145, 138, 108, 115, 69, 138,
    228, 62, 20, 250, 129, 205, 70, 239, 95, 92, 196, 209, 109, 158, 96, 56, 24, 102, 82, 13, 74,
    220, 150, 158, 114, 226, 182, 161, 228, 125, 76, 118, 123, 68, 14, 17, 205, 125, 119, 150, 179,
    137, 151, 173, 52, 198, 75, 28, 93, 139, 163, 15, 31, 198, 127, 84, 98, 120, 51, 44, 214, 59,
    197, 224, 203, 8, 137, 55, 217, 90, 248, 223, 213, 233, 82, 84, 216, 0, 55, 131, 81, 215, 182,
    130, 244, 178, 82, 246, 21, 151, 139, 254, 112, 20, 28, 37, 168, 239, 111, 78, 14, 135, 44, 55,
    253, 217, 63, 72, 170, 244, 250, 8, 137, 125, 176, 30, 38, 164, 53, 250, 14, 164, 78, 95, 217,
    109, 151, 214, 236, 159, 22, 246, 203, 146, 220, 81, 93, 63, 50, 196, 135, 158, 249, 36, 202,
    74, 205, 66, 140, 69, 233, 37, 252, 87, 248, 112, 17, 71, 187, 147, 92, 160, 237, 15, 30, 103,
    163, 9, 62, 121, 49, 82, 88, 33, 158, 15, 1, 30, 169, 125, 44, 34, 123, 122, 131, 24, 246, 46,
    214, 88, 125, 10, 88, 29, 49, 188, 38, 254, 12, 172, 105, 26, 165, 71, 69, 74, 107, 199, 154,
    207, 110, 142, 33, 100, 0, 7, 61, 144, 166, 54, 8, 148, 3, 82, 18, 132, 220, 17, 0, 154, 178,
    205, 102, 60, 31, 109, 254, 106, 40, 6, 23, 6, 228, 104, 182, 151, 21, 222, 148, 190, 219, 92,
    181, 145, 177, 155, 195, 168, 83, 14, 157, 185, 144, 89, 168, 111, 216, 76, 85, 167, 112, 151,
    5, 48, 59, 170, 173, 241, 1, 157, 101, 126, 195, 232, 158, 180, 22, 150, 185, 145, 61, 126,
    206, 227, 196, 114, 222, 128, 30, 47, 19, 118, 58, 163, 127, 225, 97, 32, 111, 185, 240, 12,
    252, 131, 202, 127, 173, 74, 51, 46, 137, 92, 209, 165, 188, 77, 113, 26, 49, 86, 127, 155, 70,
    0, 235, 189, 240, 5, 27, 192, 186, 172, 157, 67, 4, 125, 253, 92, 49, 222, 176, 112, 186, 135,
    115, 103, 207, 100, 238, 198, 237, 162, 13, 41, 83, 82, 87, 62, 40, 232, 175, 55, 148, 52, 193,
    38, 103, 228, 142, 53, 167, 192, 192, 202, 23, 56, 121, 54, 234, 75, 121, 187, 199, 35, 231,
    71, 141, 244, 104, 42, 70, 105, 185, 72, 194, 134, 246, 35, 117, 206, 90, 56, 69, 138, 22, 209,
    161, 158, 227, 254, 162, 32, 133, 3, 217, 94, 127, 189, 169, 207, 62, 1, 187, 86, 112, 50, 230,
    236, 2, 141, 116, 203, 27, 230, 29, 97, 119, 155, 23, 9, 225, 22, 214, 206, 48, 178, 179, 130,
    115, 225, 105, 19, 82, 249, 5, 213, 23, 245, 60, 159, 65, 27, 147, 210, 179, 166, 99, 38, 86,
    121, 236, 169, 21, 230, 81, 67, 219, 120, 212, 119, 81, 191, 113, 217, 30, 125, 242, 13, 143,
    35, 178, 250, 150, 136, 27, 106, 63, 63, 17, 168, 232, 186, 242, 21, 133, 248, 60, 77, 29, 193,
    233, 207, 44, 174, 151, 39, 158, 47, 124, 185, 160, 242, 46, 12, 180, 197, 117, 228, 139, 113,
    22, 82, 16, 155, 125, 16, 99, 96, 207, 154, 15, 187, 214, 133, 113, 240, 16, 32, 115, 210, 21,
    177, 64, 70, 146, 222, 66, 218, 114, 192, 225, 201, 187, 191, 158, 187, 78, 67, 59, 30, 36,
    150, 168, 115, 245, 62, 137, 253, 133, 7, 226, 50, 117, 42, 147, 166, 29, 181, 106, 12, 82,
    113, 211, 147, 84, 132, 44, 179, 73, 120, 214, 226, 179, 193, 215, 95, 48, 105, 109, 4, 235,
    63, 232, 206, 135, 22, 113, 114, 172, 241, 21, 70, 138, 111, 114, 15, 175, 2, 159, 30, 174,
    166, 58, 239, 202, 106, 109, 100, 160, 119, 238, 11, 203, 142, 38, 153, 161, 172, 104, 201,
    110, 70, 231, 0, 109, 23, 210, 11, 190, 247, 159, 77, 124, 243, 223, 191, 70, 174, 96, 207,
    134, 71, 251, 251, 252, 252, 254, 140, 91, 118, 221, 249, 162, 96, 227, 249, 133, 119, 141,
    139, 220, 44, 120, 129, 44, 110, 35, 115, 137, 151, 79, 239, 153, 187, 121, 151, 139, 153, 25,
    77, 104, 250, 186, 189, 49, 213, 224, 77, 179, 77, 40, 165, 245, 31, 90, 148, 243, 58, 232,
    149, 123, 71, 61, 181, 102, 68, 193, 78, 213, 74, 224, 195, 249, 22, 166, 10, 11, 33, 236, 122,
    81, 77, 165, 26, 90, 241, 36, 8, 51, 47, 18, 240, 113, 31, 88, 214, 125, 114, 214, 57, 210,
    102, 118, 40, 130, 113, 132, 0, 213, 179, 114, 184, 246, 120, 117, 138, 222, 68, 75, 35, 174,
    62, 31, 123, 109, 101, 28, 103, 82, 16, 35, 199, 142, 233, 94, 188, 113, 119, 205, 154, 70,
    172, 41, 248, 195, 218, 35, 85, 73, 140, 57,
];

bind_interrupts!(struct Irqs {
    OTG_FS => usb::InterruptHandler<peripherals::USB_OTG_FS>;
});

// If you are trying this and your USB device doesn't connect, the most
// common issues are the RCC config and vbus_detection
//
// See https://embassy.dev/book/#_the_usb_examples_are_not_working_on_my_board_is_there_anything_else_i_need_to_configure
// for more information.
#[embassy_executor::main]
async fn main(_spawner: Spawner) {
    info!("Hello World!");

    let mut config = Config::default();
    {
        use embassy_stm32::rcc::*;
        config.rcc.hsi48 = Some(Hsi48Config {
            sync_from_usb: true,
        }); // needed for USB
        config.rcc.sys = Sysclk::PLL1_R;
        config.rcc.hsi = true;
        config.rcc.pll = Some(Pll {
            source: PllSource::HSI,
            prediv: PllPreDiv::DIV1,
            mul: PllMul::MUL10,
            divp: None,
            divq: None,
            divr: Some(PllRDiv::DIV2), // sysclk 80Mhz (16 / 1 * 10 / 2)
        });
        config.rcc.mux.clk48sel = mux::Clk48sel::HSI48;
    }
    let p = embassy_stm32::init(config);

    // Create the driver, from the HAL.
    let mut ep_out_buffer = [0u8; 256];
    let mut config = embassy_stm32::usb::Config::default();

    // Do not enable vbus_detection. This is a safe default that works in all boards.
    // However, if your USB device is self-powered (can stay powered on if USB is unplugged), you need
    // to enable vbus_detection to comply with the USB spec. If you enable it, the board
    // has to support it or USB won't work at all. See docs on `vbus_detection` for details.
    config.vbus_detection = false;

    let driver = Driver::new_fs(
        p.USB_OTG_FS,
        Irqs,
        p.PA12,
        p.PA11,
        &mut ep_out_buffer,
        config,
    );

    // Create embassy-usb Config
    let mut config = embassy_usb::Config::new(0xc0de, 0xcafe);
    config.max_packet_size_0 = 64;
    config.manufacturer = Some("Embassy");
    config.product = Some("USB-serial example");
    config.serial_number = Some("12345678");

    // Create embassy-usb DeviceBuilder using the driver and config.
    // It needs some buffers for building the descriptors.
    let mut config_descriptor = [0; 256];
    let mut bos_descriptor = [0; 256];
    let mut control_buf = [0; 64];

    let mut state = State::new();

    let mut builder = Builder::new(
        driver,
        config,
        &mut config_descriptor,
        &mut bos_descriptor,
        &mut [], // no msos descriptors
        &mut control_buf,
    );

    // Create classes on the builder.
    let mut class = CdcAcmClass::new(&mut builder, &mut state, 64);

    // Build the builder.
    let mut usb = builder.build();

    // Run the USB device.
    let usb_fut = usb.run();

    // Do stuff with the class!
    let echo_fut = async {
        loop {
            class.wait_connection().await;
            info!("Connected");
            let _ = echo(&mut class).await;
            info!("Disconnected");
        }
    };

    // Run everything concurrently.
    // If we had made everything `'static` above instead, we could do this using separate tasks instead.
    join(usb_fut, echo_fut).await;
}

struct Disconnected {}

impl From<EndpointError> for Disconnected {
    fn from(val: EndpointError) -> Self {
        match val {
            EndpointError::BufferOverflow => panic!("Buffer overflow"),
            EndpointError::Disabled => Disconnected {},
        }
    }
}

async fn echo<'d, T: Instance + 'd>(
    class: &mut CdcAcmClass<'d, Driver<'d, T>>,
) -> Result<(), Disconnected> {
    use libcrux_iot_ml_dsa::MLDSAVerificationKey;
    use libcrux_iot_ml_dsa::ml_dsa_87::{self, MLDSA87Signature};
    let mut signature = MLDSA87Signature::zero();
    let mut index = 0;
    let mut buf = [0u8; 64];

    loop {
        let n = class.read_packet(&mut buf).await?;
        info!("read {} bytes", n);
        if n < 64 {
            signature.as_mut_slice()[index..index + n].copy_from_slice(&buf[..n]);
            break;
        } else {
            signature.as_mut_slice()[index..index + 64].copy_from_slice(&buf[..]);
            index += 64;
        }
    }

    let result = ml_dsa_87::verify(&MLDSAVerificationKey::new(VK), &[5u8; 2], b"", &signature);

    if result.is_ok() {
        info!("Signature verified!");
    } else {
        info!("Verification failed!");
    }
    Ok(())
}
